name: ATK VED Theme CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # PHP Code Quality
  php-quality:
    name: PHP Quality Checks
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-versions: ['8.1', '8.2', '8.3']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-versions }}
          extensions: mbstring, intl, pdo_mysql
          tools: composer:v2
          coverage: none

      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Run PHPStan
        run: composer phpstan
        continue-on-error: true

      - name: Run PHPCS
        run: composer phpcs
        continue-on-error: true

  # PHPUnit Tests
  phpunit:
    name: PHPUnit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-versions: ['8.1', '8.2']
        wordpress-versions: ['latest', '6.3']

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-versions }}
          extensions: mysqli, pdo_mysql
          tools: phpunit
          coverage: none

      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Install WordPress test suite
        run: |
          bash bin/install-wp-tests.sh wordpress_test root root 127.0.0.1 ${{ matrix.wordpress-versions }}

      - name: Run PHPUnit
        run: composer phpunit
        continue-on-error: true

  # JavaScript Quality
  js-quality:
    name: JavaScript Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: wp-content/themes/atk-ved/package-lock.json

      - name: Install dependencies
        working-directory: wp-content/themes/atk-ved
        run: npm ci

      - name: Run ESLint
        working-directory: wp-content/themes/atk-ved
        run: npm run lint:js
        continue-on-error: true

      - name: Run Stylelint
        working-directory: wp-content/themes/atk-ved
        run: npm run lint:css
        continue-on-error: true

  # Build Theme
  build:
    name: Build Theme
    runs-on: ubuntu-latest
    needs: [php-quality, js-quality]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: wp-content/themes/atk-ved
        run: npm ci

      - name: Build assets
        working-directory: wp-content/themes/atk-ved
        run: npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: atk-ved-theme
          path: wp-content/themes/atk-ved/dist/
          retention-days: 7

  # Security Scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run security scan
        run: |
          echo "Running security scan..."
          # Add security scanning tools here
          # Example: wp scan vulnerability
        continue-on-error: true

  # Deploy (on tag)
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [build, phpunit]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: atk-ved-theme
          path: dist/

      - name: Create release archive
        run: |
          cd dist
          zip -r ../atk-ved-theme.zip .
          cd ..

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: atk-ved-theme.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
