/**
 * Interactions - Модалки, слайдеры, галерея (Vanilla JS)
 * @package ATK_VED
 */
(function(){'use strict';const $=(s,c=document)=>c.querySelector(s);const $$=(s,c=document)=>c.querySelectorAll(s);const ce=(t,c,h)=>{const e=document.createElement(t);if(c)e.className=c;if(h)e.innerHTML=h;return e};function initCallbackModal(){const floatBtn=ce('button','callback-float-btn');floatBtn.setAttribute('aria-label','Заказать обратный звонок');floatBtn.innerHTML='<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>';document.body.appendChild(floatBtn);const modalHTML='<div class="callback-modal-overlay"><div class="callback-modal"><div class="callback-modal-header"><button class="callback-modal-close" aria-label="Закрыть">&times;</button><h3>Заказать обратный звонок</h3><p>Оставьте свой номер и мы перезвоним вам в течение 15 минут</p></div><div class="callback-modal-body"><form class="callback-form" id="callbackForm"><div class="form-group"><label for="callback-name">Ваше имя *</label><input type="text" id="callback-name" name="name" placeholder="Иван" required><span class="error-message"></span></div><div class="form-group"><label for="callback-phone">Телефон *</label><input type="tel" id="callback-phone" name="phone" placeholder="+7 (___) ___-__-__" required><span class="error-message"></span></div><div class="form-group"><label for="callback-time">Удобное время для звонка</label><select id="callback-time" name="time"><option value="any">В любое время</option><option value="morning">Утро (9:00 - 12:00)</option><option value="afternoon">День (12:00 - 15:00)</option><option value="evening">Вечер (15:00 - 18:00)</option></select></div><div class="form-group"><label class="checkbox-label"><input type="checkbox" name="privacy" required><span>Согласен с политикой конфиденциальности *</span></label><span class="error-message"></span></div><button type="submit" class="submit-btn"><span class="button-text">Заказать звонок</span><span class="button-loader"></span></button></form></div></div></div>';document.body.insertAdjacentHTML('beforeend',modalHTML);const overlay=$('.callback-modal-overlay');const closeBtn=$('.callback-modal-close');const form=$('#callbackForm');const phoneInput=$('#callback-phone');floatBtn.addEventListener('click',openCallbackModal);closeBtn.addEventListener('click',closeCallbackModal);overlay.addEventListener('click',e=>{if(e.target===overlay)closeCallbackModal()});document.addEventListener('keydown',e=>{if(e.key==='Escape'&&overlay.classList.contains('active'))closeCallbackModal()});form.addEventListener('submit',handleCallbackSubmit);phoneInput.addEventListener('input',formatPhoneNumber);showFloatButtonOnScroll()}function openCallbackModal(){$('.callback-modal-overlay').classList.add('active');document.body.style.overflow='hidden';setTimeout(()=>$('#callback-name').focus(),300)}function closeCallbackModal(){$('.callback-modal-overlay').classList.remove('active');document.body.style.overflow='';setTimeout(()=>{$('#callbackForm').reset();$$('.error-message').forEach(e=>e.textContent='');$$('.error').forEach(e=>e.classList.remove('error'))},300)}function handleCallbackSubmit(e){e.preventDefault();const form=e.target;const btn=form.querySelector('.submit-btn');if(!validateCallbackForm(form))return;btn.classList.add('loading');btn.disabled=true;const data=new FormData();data.append('action','atk_ved_contact_form');data.append('nonce',atkVed.nonce);data.append('name',form.name.value);data.append('phone',form.phone.value);data.append('email',form.phone.value+'@placeholder.com');data.append('message','Запрос обратного звонка. Удобное время: '+form.time.options[form.time.selectedIndex].text);fetch(atkVed.ajaxUrl,{method:'POST',body:data}).then(r=>r.json()).then(r=>{if(r.success){closeCallbackModal();alert('Спасибо! Мы перезвоним вам в течение 15 минут.')}else{alert('Произошла ошибка. Попробуйте позже или позвоните нам.')}}).catch(()=>alert('Ошибка соединения. Попробуйте позже.')).finally(()=>{btn.classList.remove('loading');btn.disabled=false})}function validateCallbackForm(form){let valid=true;$$('.error-message',form).forEach(e=>e.textContent='');$$('.error',form).forEach(e=>e.classList.remove('error'));const name=form.name;if(name.value.trim().length<2){showFieldError(name,'Введите корректное имя');valid=false}const phone=form.phone;if(phone.value.replace(/\D/g,'').length<11){showFieldError(phone,'Введите корректный номер телефона');valid=false}const privacy=form.privacy;if(!privacy.checked){showFieldError(privacy,'Необходимо согласие с политикой');valid=false}return valid}function showFieldError(field,msg){field.classList.add('error');field.closest('.form-group').querySelector('.error-message').textContent=msg}function formatPhoneNumber(e){let val=e.target.value.replace(/\D/g,'');if(val.length>0){if(val[0]==='7'||val[0]==='8')val='7'+val.substring(1);let fmt='+7';if(val.length>1)fmt+=' ('+val.substring(1,4);if(val.length>=5)fmt+=') '+val.substring(4,7);if(val.length>=8)fmt+='-'+val.substring(7,9);if(val.length>=10)fmt+='-'+val.substring(9,11);e.target.value=fmt}}function showFloatButtonOnScroll(){const btn=$('.callback-float-btn');btn.style.display='none';window.addEventListener('scroll',()=>{btn.style.display=window.pageYOffset>500?'flex':'none'})}let currentSlide=0,autoplayInterval;const autoplayDelay=5000;function initReviewsSlider(){const section=$('.reviews-section');if(!section)return;const grid=section.querySelector('.reviews-grid');const reviews=$$('.review-card',grid);if(!reviews.length)return;grid.classList.add('reviews-slider');reviews.forEach((r,i)=>{r.dataset.slide=i;if(i===0)r.classList.add('active')});const nav=ce('div','slider-navigation');nav.innerHTML='<button class="slider-btn slider-prev" aria-label="Предыдущий отзыв"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg></button><div class="slider-dots"></div><button class="slider-btn slider-next" aria-label="Следующий отзыв"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg></button>';section.querySelector('.container').appendChild(nav);const dots=$('.slider-dots');reviews.forEach((r,i)=>{const dot=ce('button','slider-dot'+(i===0?' active':''));dot.dataset.slide=i;dot.setAttribute('aria-label','Перейти к отзыву '+(i+1));dots.appendChild(dot)});$('.slider-prev').addEventListener('click',()=>{stopAutoplay();prevSlide();startAutoplay()});$('.slider-next').addEventListener('click',()=>{stopAutoplay();nextSlide();startAutoplay()});$$('.slider-dot').forEach(d=>d.addEventListener('click',()=>{stopAutoplay();goToSlide(+d.dataset.slide);startAutoplay()}));let touchStartX=0,touchEndX=0;grid.addEventListener('touchstart',e=>touchStartX=e.touches[0].clientX);grid.addEventListener('touchend',e=>{touchEndX=e.changedTouches[0].clientX;const diff=touchStartX-touchEndX;if(Math.abs(diff)>50){stopAutoplay();diff>0?nextSlide():prevSlide();startAutoplay()}});document.addEventListener('keydown',e=>{if(!section.offsetParent)return;if(e.key==='ArrowLeft'){stopAutoplay();prevSlide();startAutoplay()}else if(e.key==='ArrowRight'){stopAutoplay();nextSlide();startAutoplay()}});grid.addEventListener('mouseenter',stopAutoplay);grid.addEventListener('mouseleave',startAutoplay);startAutoplay()}function goToSlide(idx){const reviews=$$('.review-card');const total=reviews.length;if(idx<0)currentSlide=total-1;else if(idx>=total)currentSlide=0;else currentSlide=idx;reviews.forEach((r,i)=>r.classList.toggle('active',i===currentSlide));$$('.slider-dot').forEach((d,i)=>d.classList.toggle('active',i===currentSlide));updateSliderPosition()}function updateSliderPosition(){const slider=$('.reviews-slider');if(!slider)return;const card=$('.review-card');if(!card)return;const w=card.offsetWidth+parseInt(getComputedStyle(card).marginRight);slider.style.transform='translateX('+-currentSlide*w+'px)'}function nextSlide(){goToSlide(currentSlide+1)}function prevSlide(){goToSlide(currentSlide-1)}function startAutoplay(){stopAutoplay();autoplayInterval=setInterval(nextSlide,autoplayDelay)}function stopAutoplay(){if(autoplayInterval){clearInterval(autoplayInterval);autoplayInterval=null}}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',()=>{initCallbackModal();initReviewsSlider()})}else{initCallbackModal();initReviewsSlider()}let resizeTimer;window.addEventListener('resize',()=>{clearTimeout(resizeTimer);resizeTimer=setTimeout(updateSliderPosition,250)})})();
